<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Receipt Generator</title>
    <link rel="icon" type="image/svg+xml" href="https://www.vivexatech.online/assets/favicon/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --dark-bg: #0A101E; --dark-card: #10182C; --dark-border: #1E293B;
            --text-primary: #E2E8F0; --text-secondary: #94A3B8; --cyan: #00E6F7; --blue: #3672F8;
            --green: #22c55e; --red: #ef4444; --gray: #475569;
            --border-radius: 8px; --transition: all 0.3s ease;
        }
        body { background-color: var(--dark-bg); color: var(--text-secondary); font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 2rem; box-sizing: border-box; visibility: hidden; }
        .container { width: 100%; max-width: 1400px; }
        h2, h3 { color: var(--text-primary); text-align: center; margin-bottom: 2rem; }
        .panel-card { background-color: var(--dark-card); padding: 2rem; border-radius: var(--border-radius); border: 1px solid var(--dark-border); }
        .cta-button { display: inline-block; width: 100%; padding: 14px 32px; border: none; border-radius: var(--border-radius); background: linear-gradient(90deg, var(--cyan), var(--blue)); color: #fff; font-weight: 700; font-size: 1rem; cursor: pointer; transition: var(--transition); text-decoration: none; box-sizing: border-box; text-align: center; }
        .cta-button:hover { filter: brightness(1.2); }
        .cta-button:disabled { background: var(--gray); cursor: not-allowed; filter: brightness(0.7); }
        .back-btn { background: var(--gray); margin-bottom: 2rem; display: block; width: fit-content; padding: 10px 20px; font-size: 0.9rem;}
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 12px; background-color: var(--dark-bg); border: 1px solid var(--dark-border); border-radius: var(--border-radius); color: var(--text-primary); font-size: 1rem; box-sizing: border-box; }
        .receipt-panel-content { display: flex; gap: 2rem; align-items: flex-start; }
        .receipt-form-wrapper { flex: 1; min-width: 350px; }
        #items-container .item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        #items-container .item-row .item-name { flex-grow: 1; }
        #items-container .item-row .item-qty,
        #items-container .item-row .item-price { width: 70px; flex-shrink: 0; }
        .add-item-btn { background: var(--green); margin-bottom: 2rem;}
        .download-pdf-btn { background: var(--red); }
        
        #invoice-container {
            width: 794px; 
            min-height: 1123px; 
            background: #fff;
            color: #000;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #eee;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid #000; }
        .invoice-header h1 { font-size: 48px; font-weight: 700; margin: 0; color: #000; }
        .logo img { max-width: 150px; }
        .company-name { font-size: 36px; font-weight: bold; color: #000; text-align: right; }
        .company-name span { color: #00AEEF; }
        .invoice-details { display: flex; justify-content: space-between; margin-top: 20px; color: #333; }
        .billed-to p { margin: 5px 0; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 40px; }
        .invoice-table thead { border-bottom: 2px dotted #000; }
        .invoice-table th { text-align: left; padding: 10px; color: #555; font-weight: 500; }
        .invoice-table td { padding: 15px 10px; color: #333; }
        .invoice-table th:not(:first-child), .invoice-table td:not(:first-child) { text-align: right; }
        .invoice-table tbody tr { border-bottom: 1px dotted #ccc; }
        .invoice-table tbody tr:last-child { border-bottom: 2px dotted #000; }
        .total-section { text-align: right; margin-top: 20px; font-size: 24px; font-weight: bold; color: #000; }
        .thank-you { font-family: 'Dancing Script', cursive; font-size: 48px; color: #000; margin-top: auto; padding-top: 50px; }

        @media (max-width: 1200px) {
            .receipt-panel-content { flex-direction: column; }
            #invoice-container {
                width: 100%;
                min-height: unset;
                margin-top: 2rem;
            }
        }
        @media (max-width: 480px) {
            #items-container .item-row { flex-direction: column; align-items: stretch; }
            #items-container .item-row .item-qty,
            #items-container .item-row .item-price { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="cta-button back-btn">‚Üê Back to Dashboard</a>
        <div class="receipt-panel-content">
            <div class="receipt-form-wrapper panel-card">
                <h2>Enter Receipt Details</h2>
                <div class="form-group"><label for="client-name">Received from:</label><input type="text" id="client-name" value="Wardiere Inc." onkeyup="generateReceipt()"></div>
                <div class="form-group"><label for="receipt-no">Receipt No:</label><input type="text" id="receipt-no" value="R-12345" onkeyup="generateReceipt()"></div>
                <div class="form-group"><label for="transaction-id">Transaction ID:</label><input type="text" id="transaction-id" value="TXN-9876543210" onkeyup="generateReceipt()"></div>
                <div class="form-group"><label for="date">Date:</label><input type="date" id="date" onchange="generateReceipt()"></div>
                <hr>
                <h3>Items</h3>
                <div id="items-container">
                    <div class="item-row">
                        <input type="text" class="item-name" placeholder="Item Name" value="Digital Painting" onkeyup="generateReceipt()">
                        <input type="number" class="item-qty" placeholder="Qty" value="6" onkeyup="generateReceipt()">
                        <input type="number" class="item-price" placeholder="Price" value="100" onkeyup="generateReceipt()">
                    </div>
                </div>
                <button type="button" class="cta-button add-item-btn" onclick="addItem()">+ Add More Items</button>
                <button type="button" class="cta-button download-pdf-btn" onclick="downloadPDF()">Download PDF</button>
            </div>
            <div id="invoice-container">
                <header class="invoice-header"><h1>RECEIPT</h1><div class="logo"><img src="https://www.vivexatech.online/assets/favicon/web-app-manifest-512x512.png" alt="Vivexa Tech Logo"></div></header>
                <section class="invoice-details"><div class="billed-to"><p style="font-weight:bold; font-size:18px;">Received from:</p><p style="font-weight: bold; font-size: 20px;" id="client-name-output"></p><p>Receipt No: <span id="receipt-no-output"></span></p><p>Transaction ID: <span id="transaction-id-output"></span></p><p>Date: <span id="date-output"></span></p></div><div class="company-name">Vivexa <br><span>Tech</span></div></section>
                <table class="invoice-table"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody id="invoice-items-output"></tbody></table>
                <div class="total-section">Amount Paid &nbsp;&nbsp;&nbsp; <span id="grand-total-output"></span></div>
                <div class="thank-you">Thank you for your payment!</div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ADMIN_EMAIL = "vivexatech@gmail.com";
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const { jsPDF } = window.jspdf;

            auth.onAuthStateChanged(user => {
                if (user && user.email === ADMIN_EMAIL) {
                    document.body.style.visibility = 'visible';
                } else {
                    window.location.href = 'index.html';
                }
            });

            document.getElementById('date').valueAsDate = new Date();

            window.addItem = function() {
                const itemsContainer = document.getElementById('items-container');
                const itemRow = document.createElement('div');
                itemRow.className = 'item-row';
                itemRow.innerHTML = `<input type="text" class="item-name" placeholder="Item Name" onkeyup="generateReceipt()"><input type="number" class="item-qty" placeholder="Qty" onkeyup="generateReceipt()"><input type="number" class="item-price" placeholder="Price" onkeyup="generateReceipt()">`;
                itemsContainer.appendChild(itemRow);
            };
            
            window.generateReceipt = function() {
                const clientName = document.getElementById('client-name').value;
                const receiptNo = document.getElementById('receipt-no').value;
                const transactionId = document.getElementById('transaction-id').value;
                const dateInput = document.getElementById('date').value;
                
                let formattedDate = '';
                if (dateInput) {
                    const date = new Date(dateInput);
                    const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                    const correctedDate = new Date(date.getTime() + userTimezoneOffset);
                    formattedDate = correctedDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
                }

                document.getElementById('client-name-output').innerText = clientName;
                document.getElementById('receipt-no-output').innerText = receiptNo;
                document.getElementById('transaction-id-output').innerText = transactionId;
                document.getElementById('date-output').innerText = formattedDate;
                
                const itemRows = document.getElementById('items-container').getElementsByClassName('item-row');
                const invoiceItemsOutput = document.getElementById('invoice-items-output');
                invoiceItemsOutput.innerHTML = '';
                let grandTotal = 0;

                for (let i = 0; i < itemRows.length; i++) {
                    const name = itemRows[i].getElementsByClassName('item-name')[0].value;
                    const qty = parseFloat(itemRows[i].getElementsByClassName('item-qty')[0].value);
                    const price = parseFloat(itemRows[i].getElementsByClassName('item-price')[0].value);

                    if (name && !isNaN(qty) && !isNaN(price)) {
                        const total = qty * price;
                        grandTotal += total;
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${name}</td><td>${qty}</td><td>‚Çπ${price.toFixed(2)}</td><td>‚Çπ${total.toFixed(2)}</td>`;
                        invoiceItemsOutput.appendChild(row);
                    }
                }
                document.getElementById('grand-total-output').innerText = `‚Çπ${grandTotal.toFixed(2)}`;
            };

            window.downloadPDF = function() {
                const invoiceElement = document.getElementById('invoice-container');
                const receiptNo = document.getElementById('receipt-no').value || 'receipt';
                const downloadBtn = document.querySelector('.download-pdf-btn');
                
                downloadBtn.textContent = 'Downloading...';
                downloadBtn.disabled = true;

                html2canvas(invoiceElement, { 
                    scale: 2, 
                    useCORS: true 
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'pt',
                        format: 'a4'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const imgRatio = imgProps.width / imgProps.height;
                    const pdfRatio = pdfWidth / pdfHeight;

                    let finalWidth, finalHeight, x, y;

                    if (imgRatio > pdfRatio) {
                        finalWidth = pdfWidth;
                        finalHeight = finalWidth / imgRatio;
                        x = 0;
                        y = (pdfHeight - finalHeight) / 2;
                    } else {
                        finalHeight = pdfHeight;
                        finalWidth = finalHeight * imgRatio;
                        x = (pdfWidth - finalWidth) / 2;
                        y = 0;
                    }
                    
                    pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                    pdf.save(`receipt-${receiptNo}.pdf`);

                }).catch(err => {
                    console.error("PDF generation failed:", err);
                    alert("Could not download PDF. Check console for errors.");
                }).finally(() => {
                    downloadBtn.textContent = 'Download PDF';
                    downloadBtn.disabled = false;
                });
            };

            generateReceipt();
        });
    </script>
</body>
</html>
